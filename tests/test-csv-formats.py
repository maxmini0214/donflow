#!/usr/bin/env python3
"""DonFlow CSV/XLSX ìë™ íŒŒì‹± í…ŒìŠ¤íŠ¸ â€” ë‹¤ì–‘í•œ ì€í–‰ í¬ë§· ìƒì„± + ë¸Œë¼ìš°ì € ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸"""

import csv, json, os, tempfile, asyncio
from pathlib import Path

# â”€â”€â”€ í…ŒìŠ¤íŠ¸ CSV í¬ë§· ì •ì˜ â”€â”€â”€

FORMATS = {
    "ë±…í¬ìƒëŸ¬ë“œ": {
        "headers": ["ë‚ ì§œ", "ì‹œê°„", "íƒ€ì…", "ëŒ€ë¶„ë¥˜", "ì†Œë¶„ë¥˜", "ë‚´ìš©", "ê¸ˆì•¡", "í™”í", "ê²°ì œìˆ˜ë‹¨", "ë©”ëª¨"],
        "rows": [
            ["2026-02-15", "14:35:18", "ì§€ì¶œ", "ìƒí™œ", "ë§ˆíŠ¸", "í•˜ë‚˜ë§ˆíŠ¸", "-11200", "KRW", "ì§ì¥ì¸ìš°ëŒ€í†µì¥", ""],
            ["2026-02-14", "12:30:00", "ì§€ì¶œ", "êµí†µ", "ëŒ€ì¤‘êµí†µ", "ì¹´ì¹´ì˜¤T_ë°”ì´í¬", "-4020", "KRW", "KBë‚˜ë¼ì‚¬ë‘ìš°ëŒ€í†µì¥", ""],
            ["2026-02-13", "09:00:00", "ì§€ì¶œ", "ìƒí™œ", "ìƒí•„í’ˆ", "ë‹¤ì´ì†Œì„œíŒêµì ", "-2000", "KRW", "ì§ì¥ì¸ìš°ëŒ€í†µì¥", ""],
            ["2026-02-12", "18:00:00", "ì´ì²´", "ì´ì²´", "ë¯¸ë¶„ë¥˜", "ì¹´ì¹´ì˜¤í˜ì´", "-20000", "KRW", "ì§ì¥ì¸ìš°ëŒ€í†µì¥", ""],
            ["2026-02-10", "10:00:00", "ì§€ì¶œ", "ì‹ë¹„", "ë°°ë‹¬", "ë°°ë‹¬ì˜ë¯¼ì¡±", "-25000", "KRW", "ì§ì¥ì¸ìš°ëŒ€í†µì¥", ""],
        ],
    },
    "í† ìŠ¤": {
        "headers": ["ë‚ ì§œ", "ë‚´ìš©", "ê¸ˆì•¡", "ì”ì•¡", "ë©”ëª¨"],
        "rows": [
            ["2026.02.15", "ìŠ¤íƒ€ë²…ìŠ¤ íŒêµì ", "-5500", "1234567", ""],
            ["2026.02.14", "CU í¸ì˜ì ", "-3200", "1239767", ""],
            ["2026.02.13", "ê¸‰ì—¬ ì…ê¸ˆ", "2500000", "3739767", "ì›”ê¸‰"],
            ["2026.02.12", "ë„¤ì´ë²„í˜ì´", "-15000", "1239767", ""],
            ["2026.02.10", "êµí†µì¹´ë“œ ì¶©ì „", "-50000", "1254767", ""],
        ],
    },
    "ì‹ í•œì¹´ë“œ": {
        "headers": ["ì´ìš©ì¼ì‹œ", "ì´ìš©ê°€ë§¹ì ", "ì´ìš©ê¸ˆì•¡", "ìŠ¹ì¸ë²ˆí˜¸"],
        "rows": [
            ["2026/02/15 14:30", "GS25 íŒêµì—­ì ", "3500", "12345678"],
            ["2026/02/14 19:20", "BBQ ì¹˜í‚¨", "21000", "12345679"],
            ["2026/02/13 08:10", "ìŠ¤íƒ€ë²…ìŠ¤", "6000", "12345680"],
            ["2026/02/12 12:00", "ë§¥ë„ë‚ ë“œ", "8900", "12345681"],
            ["2026/02/10 20:00", "ì˜¬ë¦¬ë¸Œì˜", "32000", "12345682"],
        ],
    },
    "êµ­ë¯¼ì¹´ë“œ": {
        "headers": ["ê±°ë˜ì¼", "ê°€ë§¹ì ëª…", "ê²°ì œê¸ˆì•¡", "êµ¬ë¶„"],
        "rows": [
            ["2026-02-15", "ì´ë§ˆíŠ¸", "45000", "ì¼ì‹œë¶ˆ"],
            ["2026-02-14", "CGV íŒêµ", "28000", "ì¼ì‹œë¶ˆ"],
            ["2026-02-13", "êµë³´ë¬¸ê³ ", "18500", "ì¼ì‹œë¶ˆ"],
            ["2026-02-12", "ì•½êµ­", "12000", "ì¼ì‹œë¶ˆ"],
            ["2026-02-10", "ì£¼ìœ ì†Œ", "60000", "ì¼ì‹œë¶ˆ"],
        ],
    },
    "ì‚¼ì„±ì¹´ë“œ": {
        "headers": ["ìŠ¹ì¸ì¼", "ì‚¬ìš©ì²˜", "ìŠ¹ì¸ê¸ˆì•¡", "í• ë¶€"],
        "rows": [
            ["20260215", "ì¿ íŒ¡", "35000", "ì¼ì‹œë¶ˆ"],
            ["20260214", "ë„¤ì´ë²„ì‡¼í•‘", "28000", "ì¼ì‹œë¶ˆ"],
            ["20260213", "ë‹¤ì´ì†Œ", "5000", "ì¼ì‹œë¶ˆ"],
            ["20260212", "ë¬´ì‹ ì‚¬", "65000", "ì¼ì‹œë¶ˆ"],
            ["20260210", "ë°°ë¯¼", "19000", "ì¼ì‹œë¶ˆ"],
        ],
    },
    "í•˜ë‚˜ì¹´ë“œ": {
        "headers": ["ê²°ì œì¼ì‹œ", "ì¹´ë“œì‚¬ìš©ì²˜", "ì¹´ë“œê²°ì œê¸ˆì•¡", "ê²°ì œêµ¬ë¶„"],
        "rows": [
            ["2026.02.15 15:30", "í¸ì˜ì  CU", "4500", "ì‹ ìš©"],
            ["2026.02.14 20:00", "í”¼ìí—›", "32000", "ì‹ ìš©"],
            ["2026.02.13 12:00", "íƒì•¤íƒìŠ¤", "5800", "ì‹ ìš©"],
            ["2026.02.12 18:30", "ìœ ë‹ˆí´ë¡œ", "49000", "ì‹ ìš©"],
            ["2026.02.10 09:00", "ì•½êµ­", "8000", "ì‹ ìš©"],
        ],
    },
    "í˜„ëŒ€ì¹´ë“œ": {
        "headers": ["ì´ìš©ì¼ì", "ì´ìš©ì²˜", "ì´ìš©ê¸ˆì•¡", "êµ¬ë¶„"],
        "rows": [
            ["2026/02/15", "ë¡¯ë°ë§ˆíŠ¸", "67000", "ì¼ì‹œë¶ˆ"],
            ["2026/02/14", "ì˜í’ë¬¸ê³ ", "22000", "ì¼ì‹œë¶ˆ"],
            ["2026/02/13", "íˆ¬ì¸í”Œë ˆì´ìŠ¤", "7200", "ì¼ì‹œë¶ˆ"],
            ["2026/02/12", "GSì¹¼í…ìŠ¤", "55000", "ì¼ì‹œë¶ˆ"],
            ["2026/02/10", "ì½”ìŠ¤íŠ¸ì½”", "120000", "ì¼ì‹œë¶ˆ"],
        ],
    },
    "ì¹´ì¹´ì˜¤ë±…í¬": {
        "headers": ["ê±°ë˜ì¼ì‹œ", "ì ìš”", "ê±°ë˜ê¸ˆì•¡", "ì”ì•¡", "ê±°ë˜êµ¬ë¶„"],
        "rows": [
            ["2026-02-15 14:00:00", "ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ", "-8500", "500000", "ì¶œê¸ˆ"],
            ["2026-02-14 12:00:00", "ì´ì²´-í™ê¸¸ë™", "-100000", "508500", "ì´ì²´"],
            ["2026-02-13 09:00:00", "ê¸‰ì—¬", "2500000", "608500", "ì…ê¸ˆ"],
            ["2026-02-12 20:00:00", "ìë™ì´ì²´-SKT", "-67140", "108500", "ì¶œê¸ˆ"],
            ["2026-02-10 15:00:00", "ì²´í¬ì¹´ë“œ-í¸ì˜ì ", "-3200", "175640", "ì¶œê¸ˆ"],
        ],
    },
    "ë¡¯ë°ì¹´ë“œ": {
        "headers": ["ì‚¬ìš©ì¼", "ì‚¬ìš©ì²˜ëª…", "ì‚¬ìš©ê¸ˆì•¡", "ìŠ¹ì¸ë²ˆí˜¸", "í• ë¶€"],
        "rows": [
            ["2026.02.15", "ì„¸ë¸ì¼ë ˆë¸", "2800", "99887766", "ì¼ì‹œë¶ˆ"],
            ["2026.02.14", "ë§˜ìŠ¤í„°ì¹˜", "9500", "99887767", "ì¼ì‹œë¶ˆ"],
            ["2026.02.13", "ì˜¬ë¦¬ë¸Œì˜", "28000", "99887768", "ì¼ì‹œë¶ˆ"],
            ["2026.02.12", "ì´ë””ì•¼ì»¤í”¼", "4100", "99887769", "ì¼ì‹œë¶ˆ"],
            ["2026.02.10", "í™ˆí”ŒëŸ¬ìŠ¤", "53000", "99887770", "ì¼ì‹œë¶ˆ"],
        ],
    },
    "ì¼ë°˜_ì˜ì–´CSV": {
        "headers": ["date", "merchant", "amount", "category"],
        "rows": [
            ["2026-02-15", "Amazon", "-45.99", "Shopping"],
            ["2026-02-14", "Starbucks", "-6.50", "Food"],
            ["2026-02-13", "Salary", "3000.00", "Income"],
            ["2026-02-12", "Netflix", "-15.99", "Entertainment"],
            ["2026-02-10", "Gas Station", "-42.00", "Transport"],
        ],
    },
}


def generate_test_csvs(output_dir: str) -> dict:
    """ëª¨ë“  í¬ë§·ì˜ í…ŒìŠ¤íŠ¸ CSV íŒŒì¼ ìƒì„±"""
    results = {}
    os.makedirs(output_dir, exist_ok=True)
    
    for name, fmt in FORMATS.items():
        filepath = os.path.join(output_dir, f"test_{name}.csv")
        with open(filepath, "w", newline="", encoding="utf-8-sig") as f:
            writer = csv.writer(f)
            writer.writerow(fmt["headers"])
            writer.writerows(fmt["rows"])
        results[name] = filepath
        print(f"âœ… {name}: {filepath}")
    
    return results


def test_parsing_logic():
    """DonFlowì˜ íŒŒì‹± ë¡œì§ì„ ì‹œë®¬ë ˆì´ì…˜í•´ì„œ ê° í¬ë§·ì´ ì¸ì‹ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸"""
    DATE_COLS = ['ì´ìš©ì¼ì‹œ', 'ì´ìš©ì¼', 'ì´ìš©ì¼ì', 'ê±°ë˜ì¼', 'ê±°ë˜ì¼ì‹œ', 'ë‚ ì§œ', 'ì¼ì', 'ì¼ì‹œ', 'date', 'ê²°ì œì¼', 'ìŠ¹ì¸ì¼', 'ì‚¬ìš©ì¼', 'ê±°ë˜ì¼ì', 'ìŠ¹ì¸ì¼ì‹œ', 'ë§¤ì…ì¼', 'ê²°ì œì¼ì‹œ', 'ê±°ë˜ ì¼ì‹œ', 'ê²°ì œ ì¼ì‹œ', 'ë‚ ì§œ/ì‹œê°„', 'ì‹œê°„', 'ê±°ë˜ì‹œê°„']
    MERCHANT_COLS = ['ê°€ë§¹ì ', 'ê°€ë§¹ì ëª…', 'ì´ìš©ê°€ë§¹ì ', 'ì´ìš©ì²˜', 'ì ìš”', 'merchant', 'ë‚´ìš©', 'ì‚¬ìš©ì²˜', 'ìƒí˜¸', 'ìƒí˜¸ëª…', 'ê±°ë˜ì²˜', 'ë¹„ê³ ', 'ë©”ëª¨', 'ì´ìš© ë‚´ì—­', 'ê±°ë˜ë‚´ìš©', 'ì‚¬ìš©ì²˜ëª…', 'ê²°ì œì²˜', 'ì‚¬ìš© ë‚´ì—­', 'ì´ìš© ê°€ë§¹ì ', 'ê²°ì œë‚´ì—­', 'ê±°ë˜ì²˜ëª…', 'ì¹´ë“œì‚¬ìš©ì²˜']
    AMOUNT_COLS = ['ì´ìš©ê¸ˆì•¡', 'êµ­ë‚´ì´ìš©ê¸ˆì•¡', 'ê²°ì œê¸ˆì•¡', 'ê±°ë˜ê¸ˆì•¡', 'ê¸ˆì•¡', 'amount', 'ê²°ì œ', 'ì´ìš©ê¸ˆ', 'ì¶œê¸ˆ', 'ì¶œê¸ˆì•¡', 'ìŠ¹ì¸ê¸ˆì•¡', 'ì§€ì¶œê¸ˆì•¡', 'ì‚¬ìš©ê¸ˆì•¡', 'ê²°ì œ ê¸ˆì•¡', 'ë§¤ì¶œê¸ˆì•¡', 'ì¹´ë“œê²°ì œê¸ˆì•¡', 'ì¶œê¸ˆê¸ˆì•¡', 'ì§€ì¶œ', 'ìˆ˜ì…', 'ì…ê¸ˆì•¡']
    
    print("\n" + "="*60)
    print("ğŸ“‹ DonFlow ì»¬ëŸ¼ ë§¤ì¹­ í…ŒìŠ¤íŠ¸")
    print("="*60)
    
    all_pass = True
    for name, fmt in FORMATS.items():
        headers = [h.strip() for h in fmt["headers"]]
        
        date_match = [h for h in headers if h in DATE_COLS]
        merchant_match = [h for h in headers if h in MERCHANT_COLS]
        amount_match = [h for h in headers if h in AMOUNT_COLS]
        
        has_date = len(date_match) > 0
        has_amount = len(amount_match) > 0
        has_merchant = len(merchant_match) > 0
        
        status = "âœ… PASS" if (has_date and has_amount) else "âŒ FAIL"
        if not (has_date and has_amount):
            all_pass = False
        
        print(f"\n{status} â€” {name}")
        print(f"  í—¤ë”: {headers}")
        print(f"  ë‚ ì§œ: {date_match or 'âŒ ì—†ìŒ'}")
        print(f"  ê°€ë§¹ì : {merchant_match or 'âš ï¸ ì—†ìŒ (íŒ¨í„´ ê°ì§€ í•„ìš”)'}")
        print(f"  ê¸ˆì•¡: {amount_match or 'âŒ ì—†ìŒ'}")
    
    print(f"\n{'='*60}")
    print(f"ê²°ê³¼: {'âœ… ì „ì²´ í†µê³¼!' if all_pass else 'âŒ ì‹¤íŒ¨ ìˆìŒ â€” íŒŒì„œ ìˆ˜ì • í•„ìš”'}")
    print(f"{'='*60}")
    return all_pass


if __name__ == "__main__":
    # 1. íŒŒì‹± ë¡œì§ í…ŒìŠ¤íŠ¸
    passed = test_parsing_logic()
    
    # 2. í…ŒìŠ¤íŠ¸ CSV íŒŒì¼ ìƒì„±
    test_dir = os.path.join(os.path.dirname(__file__), "test-data")
    print(f"\nğŸ“ í…ŒìŠ¤íŠ¸ CSV ìƒì„± ì¤‘...")
    files = generate_test_csvs(test_dir)
    
    print(f"\nì´ {len(files)}ê°œ í¬ë§· ìƒì„± ì™„ë£Œ: {test_dir}")
    
    if not passed:
        print("\nâš ï¸ íŒŒì„œì—ì„œ ì¸ì‹ ëª»í•˜ëŠ” í¬ë§·ì´ ìˆì–´! DataInput.tsx ìˆ˜ì • í•„ìš”.")
