import { useState, useEffect, useCallback } from 'react';

const translations = {
  ko: {
    search: 'ê²€ìƒ‰...',
    changeCategory: 'ì¹´í…Œê³ ë¦¬ ë³€ê²½',
    addCategory: 'ì¹´í…Œê³ ë¦¬ ì¶”ê°€',
    editCategory: 'ì¹´í…Œê³ ë¦¬ í¸ì§‘',
    deleteGroup: 'ê·¸ë£¹ ì‚­ì œ',
    addCategoryToGroup: 'ì´ ê·¸ë£¹ì— ì¹´í…Œê³ ë¦¬ ì¶”ê°€',
    categoryName: 'ì¹´í…Œê³ ë¦¬ ì´ë¦„',
    groupNamePlaceholder: 'ê·¸ë£¹ ì´ë¦„ (ì˜ˆ: ë¶€ì—…/ìˆ˜ì…)',
    appTitle: 'ëˆí”Œë¡œìš°',
    tryDemoData: 'ğŸ² ë°ëª¨ë¡œ ì²´í—˜í•˜ê¸°',
    clearDemoData: 'ë°ëª¨ ë°ì´í„° ì‚­ì œ',
    noBudgetYet: 'ì•„ì§ ì˜ˆì‚° ê³„íšì´ ì—†ì–´ìš”',
    goToStructure: 'êµ¬ì¡° ì„¤ê³„í•˜ëŸ¬ ê°€ê¸° â†’',
    welcomeTitle: 'ëˆí”Œë¡œìš°ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤',
    welcomeDesc: 'ì˜ˆì‚°ì„ ì„¸ìš°ê³ , ì§€ì¶œì„ ì¶”ì í•˜ê³ , ëˆì´ ì–´ë””ë¡œ ê°€ëŠ”ì§€ í•œëˆˆì—. 100% ë¡œì»¬ â€” ë°ì´í„°ê°€ ì´ ë¸Œë¼ìš°ì €ë¥¼ ë– ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
    startFromScratch: 'ì²˜ìŒë¶€í„° ì§ì ‘ ì„¤ì • â†’',
    // Layout
    navDashboard: 'ëŒ€ì‹œë³´ë“œ',
    navStructure: 'êµ¬ì¡° ì„¤ê³„',
    navData: 'ë°ì´í„° ì…ë ¥',
    headerTitle: 'ğŸ’¸ ëˆí”Œë¡œìš°',
    // Dashboard
    income: 'ìˆ˜ì…',
    expense: 'ì§€ì¶œ',
    remainingBudget: 'ë‚¨ì€ ì˜ˆì‚°',
    budgetExceeded: 'ì˜ˆì‚° ì´ˆê³¼!',
    over: 'ì˜¤ë²„',
    caution: 'ì£¼ì˜!',
    categoryPlanVsActual: 'ì¹´í…Œê³ ë¦¬ë³„ ê³„íš vs ì‹¤ì œ',
    overallBurnRate: 'ì „ì²´ ì˜ˆì‚° ì†Œì§„ìœ¨',
    used: 'ì‚¬ìš©',
    planned: 'ê³„íš',
    exceeded: 'ì´ˆê³¼!',
    comfortable: 'ì—¬ìœ ',
    daysRemaining: 'ì¼',
    currentPace: 'í˜„ì¬ í˜ì´ìŠ¤ëŒ€ë¡œë©´',
    surplus: 'ì—¬ìœ ',
    overBudget: 'ì´ˆê³¼',
    forecast: 'ì˜ˆìƒ',
    savingsRate: 'ì €ì¶•ë¥ ',
    savingsRateDesc: 'ìˆ˜ì… ëŒ€ë¹„ ì €ì¶• ë¹„ìœ¨',
    excellent: 'ìš°ìˆ˜',
    good: 'ì–‘í˜¸',
    needsWork: 'ê°œì„  í•„ìš”',
    // Structure
    monthlyIncome: 'ì›” ìˆ˜ì…',
    setIncome: 'ìˆ˜ì…ì„ ì„¤ì •í•˜ì„¸ìš”',
    allocationTotal: 'ë°°ë¶„ í•©ê³„',
    unallocated: 'ë¯¸ë°°ë¶„',
    overAllocated: 'ì´ˆê³¼!',
    categoryManagement: 'ì¹´í…Œê³ ë¦¬ ê´€ë¦¬',
    done: 'ì™„ë£Œ',
    edit: 'í¸ì§‘',
    whatIfUnallocated: 'ì´ë ‡ê²Œ ë°”ê¾¸ë©´ ë¯¸ë°°ë¶„:',
    confirmDeleteGroup: 'ê·¸ë£¹ê³¼ í•˜ìœ„ ì¹´í…Œê³ ë¦¬ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
    confirm: 'í™•ì¸',
    cancel: 'ì·¨ì†Œ',
    save: 'ì €ì¥',
    setBudget: 'ì„¤ì •',
    addGroupCategory: 'ëŒ€ë¶„ë¥˜ ê·¸ë£¹ ì¶”ê°€',
    setIncomeFirst: 'ë¨¼ì € ì›” ìˆ˜ì…ì„ ì„¤ì •í•´ì£¼ì„¸ìš”',
    tapToEdit: 'ìœ„ì˜ ìˆ˜ì… ê¸ˆì•¡ì„ í„°ì¹˜í•˜ë©´ í¸ì§‘í•  ìˆ˜ ìˆì–´ìš”',
    name: 'ì´ë¦„',
    group: 'ëŒ€ë¶„ë¥˜',
    icon: 'ì•„ì´ì½˜',
    color: 'ìƒ‰ìƒ',
    preview: 'ë¯¸ë¦¬ë³´ê¸°',
    add: 'ì¶”ê°€',
    newCategory: 'ìƒˆ ì¹´í…Œê³ ë¦¬',
    // DataInput
    tabCsvUpload: 'CSV / ì—‘ì…€ ì—…ë¡œë“œ',
    tabNotifPaste: 'ì•Œë¦¼ ë¶™ì—¬ë„£ê¸°',
    tabHistory: 'ê±°ë˜ ëª©ë¡',
    csvGuideTitle: 'â“ CSV / ì—‘ì…€ íŒŒì¼ ì–´ë””ì„œ ë°›ë‚˜ìš”?',
    csvGuideSupport: 'ğŸ’¡ CSV ë˜ëŠ” ì—‘ì…€(.xlsx) íŒŒì¼ ëª¨ë‘ ì§€ì› Â· ì–´ë–¤ ì¹´ë“œì‚¬/ì•±ì´ë“  ìë™ ì¸ì‹!',
    previewLabel: 'ë¯¸ë¦¬ë³´ê¸°',
    date: 'ë‚ ì§œ',
    merchant: 'ê°€ë§¹ì ',
    amount: 'ê¸ˆì•¡',
    type: 'íƒ€ì…',
    autoClassify: 'ìë™ë¶„ë¥˜',
    incomeType: 'ìˆ˜ì…',
    transferType: 'ì´ì²´',
    expenseType: 'ì§€ì¶œ',
    selectColumns: 'âš ï¸ ì»¬ëŸ¼ì„ ì§ì ‘ ì„ íƒí•´ì£¼ì„¸ìš”',
    selectPlaceholder: 'ì„ íƒ...',
    parseWithColumns: 'ì´ ì»¬ëŸ¼ìœ¼ë¡œ íŒŒì‹±í•˜ê¸°',
    unrecognizedFormat: 'âš ï¸ ì´ íŒŒì¼ í˜•ì‹ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤',
    uploadCsvExcel: 'CSV / ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ',
    supportedApps: 'í† ìŠ¤ Â· ë±…í¬ìƒëŸ¬ë“œ Â· ì¹´ì¹´ì˜¤ë±…í¬ Â· ì‹ í•œ/ì‚¼ì„±/êµ­ë¯¼/í˜„ëŒ€/í•˜ë‚˜/ë¡¯ë°ì¹´ë“œ',
    detected: 'ê±´ ê°ì§€',
    transferExcluded: 'ì´ì²´ëŠ” ê¸°ë³¸ ì œì™¸',
    reselect: 'ë‹¤ì‹œ ì„ íƒ',
    importing: 'ê°€ì ¸ì˜¤ëŠ” ì¤‘...',
    importCount: 'ê±´ ì„í¬íŠ¸',
    importComplete: 'ì„í¬íŠ¸ ì™„ë£Œ!',
    savedCount: 'ê±´ ì €ì¥ë¨',
    uploadMore: 'ë” ì˜¬ë¦¬ê¸°',
    autoDetected: 'âœ… ìë™ ê°ì§€:',
    dateCol: 'ë‚ ì§œ',
    merchantCol: 'ê°€ë§¹ì ',
    amountCol: 'ê¸ˆì•¡',
    none: 'ì—†ìŒ',
    fix: 'ìˆ˜ì •',
    pasteNotifications: 'ì¹´ë“œ ê²°ì œ ì•Œë¦¼ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”',
    pasteExample: 'ì˜ˆì‹œ:\n[ì‚¼ì„±ì¹´ë“œ] 15,800ì› ìŠ¤íƒ€ë²…ìŠ¤ íŒêµì  02/18 14:23\n[KBêµ­ë¯¼ì¹´ë“œ] 32,000ì› ì¿ íŒ¡ 02/18 09:11',
    parse: 'íŒŒì‹±í•˜ê¸°',
    saveComplete: 'ì €ì¥ ì™„ë£Œ!',
    items: 'ê±´',
    total: 'ì´',
    won: 'ì›',
    back: 'ë’¤ë¡œ',
    saving: 'ì €ì¥ ì¤‘...',
    saveCount: 'ê±´ ì €ì¥',
    noTransactions: 'ê±°ë˜ ë‚´ì—­ì´ ì—†ì–´ìš”',
    transaction: 'ê±°ë˜',
    manual: 'ìˆ˜ë™',
    showMore: 'ë”ë³´ê¸°',
    collapse: 'ì ‘ê¸°',
    // changeDetection
    amountChanged: 'ê¸ˆì•¡ ë³€ë™',
    amountChangedDesc: 'ê²°ì œ ê¸ˆì•¡ì´ ë³€ê²½ë˜ì—ˆì–´ìš”.',
    fromTo: 'ì—ì„œ',
    to: '(ìœ¼)ë¡œ',
    spendingIncrease: 'ì§€ì¶œ ì¦ê°€ì„¸',
    last3Months: 'ì§€ë‚œ 3ê°œì›”:',
    keepIncreasing: '(ê³„ì† ì¦ê°€ ì¤‘ì´ì—ìš” ğŸ“ˆ)',
    spendingSurge: 'ì§€ì¶œ ê¸‰ì¦',
    higherThanUsual: 'ì§€ì¶œì´ í‰ì†Œë³´ë‹¤',
    percentHigher: '% ë†’ì•„ìš”',
    mostVisited: 'ğŸª ê°€ì¥ ìì£¼ ê°„ ê³³:',
    // monthLabel
    yearSuffix: 'ë…„',
    monthSuffix: 'ì›”',
    // CSV guide
    guideToss: 'ì•± â†’ ì†Œë¹„ â†’ â‹¯ â†’ ë‚´ë³´ë‚´ê¸° â†’ CSV',
    guideBanksalad: 'ì•± â†’ ê°€ê³„ë¶€ â†’ ì„¤ì • â†’ ë°ì´í„° ë‚´ë³´ë‚´ê¸°',
    guideSamsung: 'ì•±/ì›¹ â†’ ì´ìš©ë‚´ì—­ â†’ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ',
    guideKB: 'ì•±/ì›¹ â†’ ì´ìš©ë‚´ì—­ì¡°íšŒ â†’ ë‚´ë ¤ë°›ê¸°',
    guideShinhan: 'ì•±/ì›¹ â†’ ì´ìš©ëŒ€ê¸ˆëª…ì„¸ì„œ â†’ ì—‘ì…€',
    guideHyundai: 'ì•±/ì›¹ â†’ ì´ìš©ë‚´ì—­ â†’ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ',
    // changeDetection
    suggestDeductFromSurplus: 'ì—¬ìœ ìê¸ˆì—ì„œ ì°¨ê°',
    suggestSaveSavings: 'ì ˆì•½ëœ ê¸ˆì•¡ ì €ì¶•',
    // defaultWallet
    defaultWalletName: 'ê¸°ë³¸ ì§€ê°‘',
    // memo
    transferMemo: '[ì´ì²´]',
    cardSuffix: 'ì¹´ë“œ',
    // Structure groups
    groupFixed: 'ê³ ì •ë¹„',
    groupLiving: 'ìƒí™œë¹„',
    groupSavings: 'ì €ì¶•/íˆ¬ì',
    groupDiscretionary: 'ììœ ì§€ì¶œ',
    groupIncome: 'ìˆ˜ì…',
    // misc
    demoMode: 'Demo mode',
    uncategorized: 'ê¸°íƒ€',
    quickAdd10: '+10ë§Œ',
    quickAdd50: '+50ë§Œ',
    quickAdd100: '+100ë§Œ',
    budgetPreview: 'â‚©{amount}',
    addCategoryQuick: '+ ì¹´í…Œê³ ë¦¬ ì¶”ê°€',
    deleteWithTransactions: 'ê±°ë˜ {count}ê±´ì´ \'ê¸°íƒ€\'ë¡œ ì´ë™ë©ë‹ˆë‹¤',
    emptyCategoryGuide: 'ğŸ’¡ ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”',
    budgetOverWarning: 'âš ï¸ ì˜ˆì‚° í•©ê³„ê°€ ìˆ˜ì…ì„ ì´ˆê³¼í–ˆì–´ìš”!',
    longPressEdit: 'í¸ì§‘',
    longPressDelete: 'ì‚­ì œ',
    exportJsonBackup: 'ğŸ“¦ JSON ë°±ì—…',
    exportCsv: 'ğŸ“Š CSV ë‚´ë³´ë‚´ê¸°',
    exportData: 'ë°ì´í„° ë‚´ë³´ë‚´ê¸°',
  },
  en: {
    search: 'Search...',
    changeCategory: 'Change category',
    addCategory: 'Add category',
    editCategory: 'Edit category',
    deleteGroup: 'Delete group',
    addCategoryToGroup: 'Add category to this group',
    categoryName: 'Category name',
    groupNamePlaceholder: 'Group name (e.g. Side job/Income)',
    appTitle: 'DonFlow - Budget Planner',
    tryDemoData: 'ğŸ² Try with Demo Data',
    clearDemoData: 'Clear Demo Data',
    noBudgetYet: 'No budget plan yet',
    goToStructure: 'Go to Structure â†’',
    welcomeTitle: 'Welcome to DonFlow',
    welcomeDesc: 'Plan your budget, track spending, and see exactly where your money goes. 100% private â€” your data never leaves this browser.',
    startFromScratch: 'Start from scratch â†’',
    // Layout
    navDashboard: 'Dashboard',
    navStructure: 'Structure',
    navData: 'Data Input',
    headerTitle: 'ğŸ’¸ DonFlow',
    // Dashboard
    income: 'Income',
    expense: 'Expense',
    remainingBudget: 'Remaining',
    budgetExceeded: 'Over budget!',
    over: 'over',
    caution: 'Caution!',
    categoryPlanVsActual: 'Category: Plan vs Actual',
    overallBurnRate: 'Overall budget usage',
    used: 'used',
    planned: 'planned',
    exceeded: 'exceeded!',
    comfortable: 'on track',
    daysRemaining: 'days',
    currentPace: 'At current pace,',
    surplus: 'surplus',
    overBudget: 'over',
    forecast: 'projected',
    savingsRate: 'Savings Rate',
    savingsRateDesc: 'Percentage of income saved',
    excellent: 'Excellent',
    good: 'Good',
    needsWork: 'Needs work',
    // Structure
    monthlyIncome: 'Monthly Income',
    setIncome: 'Set your income',
    allocationTotal: 'Allocated total',
    unallocated: 'Unallocated',
    overAllocated: 'Over!',
    categoryManagement: 'Category Management',
    done: 'Done',
    edit: 'Edit',
    whatIfUnallocated: 'What-if unallocated:',
    confirmDeleteGroup: 'Delete this group and all its categories?',
    confirm: 'Confirm',
    cancel: 'Cancel',
    save: 'Save',
    setBudget: 'Set',
    addGroupCategory: 'Add category group',
    setIncomeFirst: 'Set your monthly income first',
    tapToEdit: 'Tap the income amount above to edit',
    name: 'Name',
    group: 'Group',
    icon: 'Icon',
    color: 'Color',
    preview: 'Preview',
    add: 'Add',
    newCategory: 'New Category',
    // DataInput
    tabCsvUpload: 'CSV / Excel Upload',
    tabNotifPaste: 'Paste Notifications',
    tabHistory: 'Transactions',
    csvGuideTitle: 'â“ Where to get CSV / Excel files?',
    csvGuideSupport: 'ğŸ’¡ Supports CSV and Excel (.xlsx) Â· Auto-detects any card company or app!',
    previewLabel: 'Preview',
    date: 'Date',
    merchant: 'Merchant',
    amount: 'Amount',
    type: 'Type',
    autoClassify: 'Auto-classify',
    incomeType: 'Income',
    transferType: 'Transfer',
    expenseType: 'Expense',
    selectColumns: 'âš ï¸ Please select columns manually',
    selectPlaceholder: 'Select...',
    parseWithColumns: 'Parse with these columns',
    unrecognizedFormat: 'âš ï¸ Unrecognized file format',
    uploadCsvExcel: 'Upload CSV / Excel file',
    supportedApps: 'Toss Â· BankSalad Â· KakaoBank Â· Shinhan/Samsung/KB/Hyundai/Hana/Lotte Card',
    detected: 'detected',
    transferExcluded: 'Transfers excluded by default',
    reselect: 'Re-select',
    importing: 'Importing...',
    importCount: 'Import',
    importComplete: 'Import complete!',
    savedCount: 'saved',
    uploadMore: 'Upload more',
    autoDetected: 'âœ… Auto-detected:',
    dateCol: 'Date',
    merchantCol: 'Merchant',
    amountCol: 'Amount',
    none: 'none',
    fix: 'Fix',
    pasteNotifications: 'Paste card payment notifications here',
    pasteExample: 'Example:\n[Samsung Card] â‚©15,800 Starbucks Pangyo 02/18 14:23\n[KB Card] â‚©32,000 Coupang 02/18 09:11',
    parse: 'Parse',
    saveComplete: 'Save complete!',
    items: 'items',
    total: 'Total',
    won: '',
    back: 'Back',
    saving: 'Saving...',
    saveCount: 'Save',
    noTransactions: 'No transactions yet',
    transaction: 'Transaction',
    manual: 'Manual',
    showMore: 'Show more',
    collapse: 'Collapse',
    // changeDetection
    amountChanged: 'Amount changed',
    amountChangedDesc: 'Payment amount has changed.',
    fromTo: 'from',
    to: 'to',
    spendingIncrease: 'Spending increase',
    last3Months: 'Last 3 months:',
    keepIncreasing: '(keeps increasing ğŸ“ˆ)',
    spendingSurge: 'Spending surge',
    higherThanUsual: 'spending is',
    percentHigher: '% higher than usual',
    mostVisited: 'ğŸª Most visited:',
    // monthLabel
    yearSuffix: '',
    monthSuffix: '',
    // CSV guide
    guideToss: 'App â†’ Spending â†’ â‹¯ â†’ Export â†’ CSV',
    guideBanksalad: 'App â†’ Budget â†’ Settings â†’ Export data',
    guideSamsung: 'App/Web â†’ Usage history â†’ Download Excel',
    guideKB: 'App/Web â†’ Usage inquiry â†’ Download',
    guideShinhan: 'App/Web â†’ Statement â†’ Excel',
    guideHyundai: 'App/Web â†’ Usage history â†’ Download Excel',
    // changeDetection
    suggestDeductFromSurplus: 'Deduct from surplus',
    suggestSaveSavings: 'Save the difference',
    // defaultWallet
    defaultWalletName: 'Default Wallet',
    // memo
    transferMemo: '[Transfer]',
    cardSuffix: 'Card',
    // Structure groups
    groupFixed: 'Fixed',
    groupLiving: 'Living',
    groupSavings: 'Savings/Investment',
    groupDiscretionary: 'Discretionary',
    groupIncome: 'Income',
    // misc
    demoMode: 'Demo mode',
    uncategorized: 'Other',
    quickAdd10: '+100K',
    quickAdd50: '+500K',
    quickAdd100: '+1M',
    budgetPreview: 'â‚©{amount}',
    addCategoryQuick: '+ Add category',
    deleteWithTransactions: '{count} transactions will move to \'Other\'',
    emptyCategoryGuide: 'ğŸ’¡ Add some categories to get started',
    budgetOverWarning: 'âš ï¸ Budget total exceeds your income!',
    longPressEdit: 'Edit',
    longPressDelete: 'Delete',
    exportJsonBackup: 'ğŸ“¦ JSON Backup',
    exportCsv: 'ğŸ“Š CSV Export',
    exportData: 'Export Data',
  },
} as const;

export type Lang = 'ko' | 'en';
export type TKey = keyof typeof translations.ko;

function detectLang(): Lang {
  const saved = localStorage.getItem('donflow-lang') as Lang | null;
  if (saved === 'ko' || saved === 'en') return saved;
  return navigator.language.startsWith('ko') ? 'ko' : 'en';
}

let currentLang: Lang = detectLang();
const listeners = new Set<() => void>();

export function getLang(): Lang { return currentLang; }

export function setLang(lang: Lang) {
  currentLang = lang;
  localStorage.setItem('donflow-lang', lang);
  document.title = translations[lang].appTitle;
  listeners.forEach(fn => fn());
}

export function t(key: TKey): string {
  return translations[currentLang][key];
}

export function useLanguage() {
  const [, rerender] = useState(0);
  useEffect(() => {
    const fn = () => rerender(n => n + 1);
    listeners.add(fn);
    return () => { listeners.delete(fn); };
  }, []);
  return { lang: currentLang, setLang, t };
}

// Set initial title
if (typeof document !== 'undefined') {
  document.title = translations[currentLang].appTitle;
}
